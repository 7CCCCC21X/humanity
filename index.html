<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Humanity 测试网批量查询</title>
    <style>
        body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#f4f7f9}
        h1{text-align:center;color:#4caf50}
        .container{max-width:800px;margin:auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,.1)}
        textarea{width:100%;height:150px;padding:10px;font-size:14px;border:1px solid #ccc;border-radius:4px;color:#000}
        button{width:100%;padding:10px;font-size:16px;background:#4caf50;color:#fff;border:none;border-radius:4px;cursor:pointer}
        button:hover{background:#45a049}
        table{width:100%;border-collapse:collapse;margin-top:20px}
        table,th,td{border:1px solid #ddd}
        th,td{padding:12px;text-align:left}
        th{background:#f4f7f9}
        .stats{margin-top:20px;font-size:18px;color:#333}
        .footer{text-align:center;margin-top:30px;font-size:14px}
    </style>
</head>
<body>
<div class="container">
    <h1>Humanity 测试网批量查询代币</h1>

    <label for="wallets">请输入钱包地址，每行一个地址：</label>
    <textarea id="wallets" placeholder="0x0000…"></textarea>
    <button onclick="batchQuery()">查询积分</button>

    <div class="stats">
        <p>查询地址总数：<span id="totalAddresses">0</span></p>
        <p>有代币地址数量：<span id="withTokens">0</span></p>
        <p>无代币地址数量：<span id="withoutTokens">0</span></p>
        <p>代币总和：<span id="totalTokens">0</span> RWT</p>
    </div>

    <table id="resultTable">
        <thead>
        <tr><th>编号</th><th>钱包地址</th><th>代币数量</th><th>最后领取时间</th></tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="footer">
        作者推特：<a href="https://x.com/0xXIAOc" target="_blank">@0xXIAOc</a><br>
        Humanity 注册入口：
        <a href="https://testnet.humanity.org/login?ref=xiaocdadada" target="_blank">
            testnet.humanity.org/login?ref=xiaocdadada
        </a>
    </div>
</div>

<script>
const PROXY = 'https://corsproxy.io/'; // 公共 CORS 代理前缀

async function batchQuery () {
    const wallets = document
        .getElementById('wallets')
        .value
        .trim()
        .split('\n')
        .map(w => w.trim())
        .filter(Boolean);

    const tbody = document.querySelector('#resultTable tbody');
    tbody.innerHTML = '';

    let withTokens = 0, withoutTokens = 0, totalTokens = 0;

    for (const [idx, address] of wallets.entries()) {
        const tokenURL   = `${PROXY}https://explorer.testnet.humanity.org/api/v2/addresses/${address}/tokens?type=ERC-20`;
        const txURL      = `${PROXY}https://explorer.testnet.humanity.org/api/v2/addresses/${address}/token-transfers?type=ERC-20`;

        /* 代币余额 */
        let amount = '未找到信息';
        try {
            const { items = [] } = await fetch(tokenURL).then(r => r.json());
            if (items.length) {
                const { value, token } = items[0];
                amount = Number(value) / 10 ** token.decimals;
                withTokens++;
                totalTokens += amount;
            } else {
                withoutTokens++;
            }
        } catch (e) {
            amount = '请求失败';
            withoutTokens++;
        }

        /* 最后领取时间 */
        let lastTime = '未找到时间';
        try {
            const { items = [] } = await fetch(txURL).then(r => r.json());
            if (items.length) lastTime = new Date(items[0].timestamp).toLocaleString();
        } catch (e) {
            lastTime = '请求失败';
        }

        /* 渲染表格 */
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${idx + 1}</td>
            <td>${address}</td>
            <td>${amount}</td>
            <td>${lastTime}</td>`;
    }

    /* 汇总 */
    document.getElementById('totalAddresses').textContent = wallets.length;
    document.getElementById('withTokens').textContent     = withTokens;
    document.getElementById('withoutTokens').textContent  = withoutTokens;
    document.getElementById('totalTokens').textContent    = totalTokens.toFixed(2);
}
</script>
</body>
</html>
